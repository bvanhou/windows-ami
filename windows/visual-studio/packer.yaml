--- 
builders: 
  - 
    access_key: ""
    ami_groups: all
    ami_name: "windows-server-2019-vs2019-{{timestamp}}"
    communicator: winrm
    instance_type: m5.2xlarge
    launch_block_device_mappings: 
      - 
        delete_on_termination: true
        device_name: /dev/sda1
        volume_size: 160
        volume_type: gp2
    region: "{{ user \"ami_region\" }}"
    secret_key: ""
    source_ami_filter: 
      filters: 
        name: Windows_Server-2019-English-Full-ContainersLatest-*
        root-device-type: ebs
        virtualization-type: hvm
      most_recent: true
      owners: 
        - amazon
        - 241099261431
    tags: 
      circle_build_url: "{{ user \"circle_build_url\" }}"
      circle_job_name: "{{ user \"circle_job_name\" }}"
      circle_sha: "{{ user \"circle_sha\" }}"
      monorepo_content_sha: "{{ user \"monorepo_content_sha\" }}"
    type: amazon-ebs
    user_data_file: ./windows/visual-studio/user_data.ps1
    winrm_insecure: true
    winrm_timeout: 30m
    winrm_use_ssl: true
    winrm_username: "{{ user \"windows_user\" }}"
provisioners: 
  - 
    destination: "{{user `helper_script_folder`}}"
    source: windows/ImageHelpers
    type: file
  - 
    destination: "{{user `test_script_folder`}}"
    source: windows/validation-scripts
    type: file
  - 
    destination: "C:\\"
    source: windows/shutdown-scripts
    type: file
  - 
    elevated_password: "{{.WinRMPassword}}"
    elevated_user: "{{ user \"windows_user\" }}"
    scripts: 
      - windows/provision-scripts/install-windows-updates.ps1
      - windows/provision-scripts/init-image.ps1
      - windows/provision-scripts/disable-windows-defender-scanner.ps1
      - windows/provision-scripts/dscConfig.ps1
    type: powershell
  - 
    type: windows-restart
  - 
    elevated_password: "{{.WinRMPassword}}"
    elevated_user: "{{ user \"windows_user\" }}"
    scripts: 
      - windows/provision-scripts/dscConfig.ps1
    type: powershell
  - 
    type: windows-restart
  - 
    elevated_password: "{{.WinRMPassword}}"
    elevated_user: "{{ user \"windows_user\" }}"
    scripts: 
      - windows/provision-scripts/dscConfig.ps1
    type: powershell
  - 
    type: windows-restart
  - 
    elevated_password: "{{.WinRMPassword}}"
    elevated_user: "{{ user \"windows_user\" }}"
    scripts: 
      - windows/provision-scripts/dscConfig.ps1
    type: powershell
  - 
    elevated_password: "{{.WinRMPassword}}"
    elevated_user: "{{ user \"windows_user\" }}"
    scripts: 
      - windows/validation-scripts/prep-pester.ps1
      - windows/validation-scripts/run-pester.ps1
      - windows/provision-scripts/scan-image.ps1
    type: powershell
  - 
    destination: /tmp/artifacts/Vs2019-Server2019-Readme.md
    direction: download
    source: "C:\\InstalledSoftware.md"
    type: file
  - 
    destination: "{{ user `test_results_path` }}"
    direction: download
    source: "C:\\test-results.xml"
    type: file
  - 
    destination: /tmp/artifacts/chocolatey.log
    direction: download
    source: "C:\\ProgramData\\chocolatey\\logs\\chocolatey.log"
    type: file
  - 
    type: windows-restart
  - 
    elevated_password: "{{.WinRMPassword}}"
    elevated_user: "{{ user \"windows_user\" }}"
    scripts: 
      - windows/provision-scripts/install-ssh.ps1
      - windows/provision-scripts/enable-ec2launch.ps1
      - windows/provision-scripts/enable-cleanup.ps1
    type: powershell
variables: 
  circle_build_url: "{{ env \"CIRCLE_BUILD_URL\"}}"
  circle_job_name: "{{ env \"CIRCLE_JOB\" }}"
  circle_sha: "{{ env \"CIRCLE_SHA1\" }}"
  helper_script_folder: "C:\\Program Files\\WindowsPowerShell\\Modules\\"
  shutdown_script_folder: "C:\\shutdown-scripts"
  test_script_folder: "C:\\tests"
